---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import Tile from '../components/Tile.astro';
import BlogTile from '../components/BlogTile.astro';
import blogs from '../data/blogs.json';

const allCases = await getCollection('cases');

// Group cases by year
const casesByYear = allCases.reduce((acc, caseEntry) => {
  const year = caseEntry.data.year;
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(caseEntry);
  return acc;
}, {} as Record<number, typeof allCases>);

// Sort by year (descending) and by priority within each year
const sortedYears = Object.keys(casesByYear)
  .map(Number)
  .sort((a, b) => b - a);

for (const year of sortedYears) {
  casesByYear[year].sort((a, b) => a.data.priority - b.data.priority);
}
---

<Base 
  title="Zhiyuan designed" 
  description="Zhiyuan's selected designs. Passionate and experienced product designer, based in the Netherlands ðŸ‡³ðŸ‡±, helping make a better Internet at Cloudflare."
  isIndex={true}
>
  <h1 class="font-sans font-normal text-lg lg:text-2xl" style="text-wrap: balance;">
    <a href="/about-zhiyuan" class="font-bold">Zhiyuan</a>
    - product manager based in
    <a href="https://www.holland.com/" target="_blank" rel="noopener noreferrer">the Netherlands</a>
    , helping make a better Internet at
    <a href="https://www.cloudflare.com/" target="_blank" rel="noopener noreferrer">Cloudflare</a>.
  </h1>

  <section>
    <div>
      {blogs.map((blog) => (
        <BlogTile 
          url={blog.url}
          title={blog.title}
          date={blog.date}
          hn={blog.hn}
        />
      ))}
    </div>
  </section>

  <hr class="h-px bg-stone-300 border-0">

  <section>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-y-8">
      {sortedYears.map((year) => (
        <div>
          <h3 class="font-sans font-semibold text-sm text-stone-400 m-0">{year}</h3>
          {casesByYear[year].map((caseEntry) => (
            <Tile 
              url={`/cases/${caseEntry.id.split('/')[0]}/`}
              title={caseEntry.data.title}
              tags={caseEntry.data.tags}
            />
          ))}
        </div>
      ))}
    </div>
  </section>

  <script>
    type CaseData = {
      element: HTMLElement;
      tags: Set<string>;
      buttons: { element: HTMLElement; tag: string }[];
    };

    let cachedCases: CaseData[] | null = null;

    function getCachedCases(): CaseData[] {
      if (!cachedCases) {
        const tiles = document.querySelectorAll('.case-tile');
        cachedCases = Array.from(tiles).map((tile) => {
          const el = tile as HTMLElement;
          const tagStr = el.dataset.tags || '';
          const tags = new Set(tagStr ? tagStr.split(',') : []);

          // Using the new .tag-btn class for efficient querying
          const buttonEls = el.querySelectorAll('.tag-btn');
          const buttons = Array.from(buttonEls).map((btn) => ({
            element: btn as HTMLElement,
            tag: (btn as HTMLElement).dataset.tag || ''
          }));

          return { element: el, tags, buttons };
        });
      }
      return cachedCases;
    }

    function selectTags() {
      const cases = getCachedCases();
      const activeTag = window.location.hash.slice(1);
      const hasActiveTag = activeTag.length > 0;

      for (const caseData of cases) {
        const { element, tags, buttons } = caseData;

        // Visibility logic
        let isVisible = true;
        if (hasActiveTag) {
          isVisible = tags.has(activeTag);
        }

        // Update opacity
        if (isVisible) {
          element.classList.remove('opacity-40');
        } else {
          element.classList.add('opacity-40');
        }

        // Update buttons highlighting
        for (const btnData of buttons) {
          const btn = btnData.element;
          // Highlight if matches active tag
          const isSelected = hasActiveTag && btnData.tag === activeTag;

          if (isSelected) {
            btn.classList.remove('border-stone-600', 'text-stone-600');
            btn.classList.add('border-highlight', 'bg-highlight', 'text-stone-100');
          } else {
            // Reset to default
            btn.classList.add('border-stone-600', 'text-stone-600');
            btn.classList.remove('border-highlight', 'bg-highlight', 'text-stone-100');
          }
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => selectTags());
    window.onhashchange = () => selectTags();

    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      const button = target.closest('.tag-btn');
      if (button) {
        const tag = (button as HTMLElement).dataset.tag;
        if (tag) {
          if (tag === window.location.hash.slice(1)) {
            window.location.assign("#");
          } else {
            window.location.assign(`#${tag}`);
          }
        }
      }
    });
  </script>
</Base>
