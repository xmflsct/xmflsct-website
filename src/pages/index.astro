---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import Tile from '../components/Tile.astro';
import BlogTile from '../components/BlogTile.astro';
import blogs from '../data/blogs.json';

const allCases = await getCollection('cases');

// Group cases by year
const casesByYear = allCases.reduce((acc, caseEntry) => {
  const year = caseEntry.data.year;
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(caseEntry);
  return acc;
}, {} as Record<number, typeof allCases>);

// Sort by year (descending) and by priority within each year
const sortedYears = Object.keys(casesByYear)
  .map(Number)
  .sort((a, b) => b - a);

for (const year of sortedYears) {
  casesByYear[year].sort((a, b) => a.data.priority - b.data.priority);
}
---

<Base 
  title="Zhiyuan designed" 
  description="Zhiyuan's selected designs. Passionate and experienced product designer, based in the Netherlands ðŸ‡³ðŸ‡±, helping make a better Internet at Cloudflare."
  isIndex={true}
>
  <h1 class="font-sans font-normal text-lg lg:text-2xl" style="text-wrap: balance;">
    <a href="/about-zhiyuan" class="font-bold">Zhiyuan</a>
    - product manager based in
    <a href="https://www.holland.com/" target="_blank" rel="noopener noreferrer">the Netherlands</a>
    , helping make a better Internet at
    <a href="https://www.cloudflare.com/" target="_blank" rel="noopener noreferrer">Cloudflare</a>.
  </h1>

  <section>
    <div>
      {blogs.map((blog) => (
        <BlogTile 
          url={blog.url}
          title={blog.title}
          date={blog.date}
          hn={blog.hn}
        />
      ))}
    </div>
  </section>

  <hr class="h-px bg-stone-300 border-0">

  <section>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-y-8">
      {sortedYears.map((year) => (
        <div>
          <h3 class="font-sans font-semibold text-sm text-stone-400 m-0">{year}</h3>
          {casesByYear[year].map((caseEntry) => (
            <Tile 
              url={`/cases/${caseEntry.id.split('/')[0]}/`}
              title={caseEntry.data.title}
              tags={caseEntry.data.tags}
            />
          ))}
        </div>
      ))}
    </div>
  </section>

  <script>
    let cachedTiles: NodeListOf<Element> | null = null;

    function selected(element: Element, tag: string) {
      const buttons = element.querySelectorAll('.tag-btn');
      buttons.forEach((node) => {
        const btn = node as HTMLElement;
        if (btn.dataset.tag === tag) {
          btn.classList.remove('border-stone-600', 'text-stone-600');
          btn.classList.add('border-highlight', 'bg-highlight', 'text-stone-100');
        }
      });
    }

    function unselected(element: Element) {
      const buttons = element.querySelectorAll('.tag-btn');
      buttons.forEach((node) => {
        const btn = node as HTMLElement;
        btn.classList.add('border-stone-600', 'text-stone-600');
        btn.classList.remove('border-highlight', 'bg-highlight', 'text-stone-100');
      });
    }

    function selectTags() {
      if (!cachedTiles) return;

      const tag = window.location.hash.slice(1);

      cachedTiles.forEach(function(tile) {
        const tags = (tile as HTMLElement).dataset.tags || '';
        if (tag.length > 0) {
          if (tags.split(',').includes(tag)) {
            tile.classList.remove('opacity-40');
            selected(tile, tag);
          } else {
            tile.classList.add('opacity-40');
            unselected(tile);
          }
        } else {
          tile.classList.remove('opacity-40');
          unselected(tile);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      cachedTiles = document.querySelectorAll('.case-tile');
      selectTags();
    });
    window.onhashchange = () => selectTags();

    document.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      const button = target.closest('.tag-btn');
      if (button) {
        const tag = (button as HTMLElement).dataset.tag;
        if (tag) {
          if (tag === window.location.hash.slice(1)) {
            window.location.assign("#");
          } else {
            window.location.assign(`#${tag}`);
          }
        }
      }
    });
  </script>
</Base>
