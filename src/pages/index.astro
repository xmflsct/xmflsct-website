---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import Tile from '../components/Tile.astro';

const allCases = await getCollection('cases');

// Group cases by year
const casesByYear = allCases.reduce((acc, caseEntry) => {
  const year = caseEntry.data.year;
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(caseEntry);
  return acc;
}, {} as Record<number, typeof allCases>);

// Sort by year (descending) and by priority within each year
const sortedYears = Object.keys(casesByYear)
  .map(Number)
  .sort((a, b) => b - a);

for (const year of sortedYears) {
  casesByYear[year].sort((a, b) => a.data.priority - b.data.priority);
}
---

<Base 
  title="Zhiyuan designed" 
  description="Zhiyuan's selected designs. Passionate and experienced product designer, based in the Netherlands ðŸ‡³ðŸ‡±, helping make a better Internet at Cloudflare."
  isIndex={true}
>
  <h1 class="font-sans font-normal text-lg lg:text-2xl" style="text-wrap: balance;">
    <a href="/about-zhiyuan" class="font-bold">Zhiyuan</a>
    - product manager based in
    <a href="https://www.holland.com/" target="_blank" rel="noopener noreferrer">the Netherlands</a>
    , helping make a better Internet at
    <a href="https://www.cloudflare.com/" target="_blank" rel="noopener noreferrer">Cloudflare</a>.
  </h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-y-8">
    {sortedYears.map((year) => (
      <div>
        <h2 class="font-sans font-semibold text-sm text-stone-400 m-0">{year}</h2>
        {casesByYear[year].map((caseEntry) => (
          <Tile 
            url={`/cases/${caseEntry.id.split('/')[0]}/`}
            title={caseEntry.data.title}
            tags={caseEntry.data.tags}
          />
        ))}
      </div>
    ))}
  </div>

  <script>
    function selectTags() {
      function selected(element: Element, tag: string) {
        for (const node of element.children) {
          if (node.nodeName === 'BUTTON') {
            const btn = node as HTMLElement;
            if (btn.dataset.tag === tag) {
              btn.classList.remove('border-stone-600');
              btn.classList.remove('text-stone-600');
              btn.classList.add('border-highlight');
              btn.classList.add('bg-highlight');
              btn.classList.add('text-stone-100');
            }
          }
        }
      }
      function unselected(element: Element) {
        for (const node of element.children) {
          if (node.nodeName === 'BUTTON') {
            node.classList.add('border-stone-600');
            node.classList.add('text-stone-600');
            node.classList.remove('border-highlight');
            node.classList.remove('bg-highlight');
            node.classList.remove('text-stone-100');
          }
        }
      }
      document.querySelectorAll('.case-tile').forEach(function(tile) {
        const tag = window.location.hash.slice(1);
        const tags = (tile as HTMLElement).dataset.tags || '';
        if (tag.length > 0) {
          if (tags.includes(tag)) {
            tile.classList.remove('opacity-40');
            selected(tile, tag);
          } else {
            tile.classList.add('opacity-40');
            unselected(tile);
          }
        } else {
          tile.classList.remove('opacity-40');
          unselected(tile);
        }
      });
    }
    window.onload = () => selectTags();
    window.onhashchange = () => selectTags();

    (window as any).checkTags = function(tags: string) {
      if (tags === window.location.hash.slice(1)) {
        window.location.assign("#");
      } else {
        window.location.assign(`#${tags}`);
      }
    };
  </script>
</Base>
